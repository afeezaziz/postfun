{% extends 'base.html' %}
{% block title %}{{ token.symbol }} Pool | Postfun{% endblock %}
{% block content %}
  <section class="card">
    <h1>
      <span class="badge">{{ token.symbol }}</span>
      {{ token.name }}
    </h1>
    <div class="pf-grid" style="grid-template-columns: 2fr 1fr;">
      <div class="card">
        <div class="pf-tabs" data-tabs>
          <div class="pf-tab-list">
            <button class="pf-tab pf-tab-active" data-tab-target="chart">Chart</button>
            <button class="pf-tab" data-tab-target="holders">Holders</button>
            <button class="pf-tab" data-tab-target="swaps">Swaps</button>
          </div>
          <div class="pf-tab-contents">
            <div class="pf-tab-content pf-tab-content-active" data-tab-content="chart">
              <div class="pf-chart" id="pf-chart" data-series='{{ series | tojson }}'>
                <svg class="pf-chart-svg" width="100%" height="160" preserveAspectRatio="none">
                  <path class="pf-chart-path" d="" fill="none" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
              <div style="display:flex; justify-content: space-between; font-size: 14px; color: var(--dim-green);">
                <span>Min: <span id="pf-chart-min">—</span></span>
                <span>Max: <span id="pf-chart-max">—</span></span>
              </div>
            </div>
            <div class="pf-tab-content" data-tab-content="holders">
              <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                {% for h in holders %}
                  <div class="card">
                    <div>#{{ h.rank }} — <span class="pf-green">{{ h.address }}</span></div>
                    <div>Amount: <span class="pf-green">{{ '%.4f'|format(h.amount) }}</span></div>
                  </div>
                {% else %}
                  <div>No holders yet.</div>
                {% endfor %}
              </div>
            </div>
            <div class="pf-tab-content" data-tab-content="swaps">
              <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                {% for s in swaps %}
                  <div class="card">
                    <div>{{ s.time }}</div>
                    <div>Side: <span class="pf-green">{{ s.side }}</span></div>
                    <div>Amount: <span class="pf-green">{{ '%.4f'|format(s.amount) }}</span></div>
                    <div>Price: <span class="pf-green">{{ '%.6f'|format(s.price) }}</span></div>
                  </div>
                {% else %}
                  <div>No swaps yet.</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Trade {{ token.symbol }}</h2>
        {% if confirm_trade_preview and trade_form %}
          <div class="card" style="margin-bottom: 8px;">
            <h3>Confirm Trade</h3>
            <div>Side: <strong>{{ trade_form.side }}</strong></div>
            <div>Amount: <strong>{{ trade_form.amount }}</strong></div>
            <div>Price: <strong>{{ trade_form.price }}</strong></div>
            <div>Total: <strong>{{ trade_form.total }}</strong></div>
          </div>
          <form method="POST" action="{{ url_for('web.pool_trade', symbol=token.symbol) }}">
            <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
            <input type="hidden" name="side" value="{{ trade_form.side }}" />
            <input type="hidden" name="amount" value="{{ trade_form.amount }}" />
            <input type="hidden" name="confirm" value="yes" />
            <button class="retro-button" type="submit">Confirm and Execute</button>
            <a class="retro-button" href="{{ url_for('web.pool', symbol=token.symbol) }}">Back</a>
          </form>
        {% else %}
          <form method="POST" action="{{ url_for('web.pool_trade', symbol=token.symbol) }}" id="pf-trade-form" data-price="{{ token.price or 0 }}">
            <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
            <div style="margin-bottom:8px;">
              {% set side_val = (trade_form.side if trade_form and trade_form.side else 'buy') %}
              <label style="display:inline-flex; align-items:center; gap: 8px;">
                <input type="radio" name="side" value="buy" {% if side_val == 'buy' %}checked{% endif %}/> Buy
              </label>
              <label style="display:inline-flex; align-items:center; gap: 8px; margin-left: 12px;">
                <input type="radio" name="side" value="sell" {% if side_val == 'sell' %}checked{% endif %}/> Sell
              </label>
            </div>
            <div style="margin-bottom:8px;">
              <label>Amount</label>
              <input class="retro-input" type="text" name="amount" value="{{ trade_form.amount if trade_form and trade_form.amount }}" placeholder="e.g. 10" />
            </div>
            <div style="margin-bottom:8px;">
              <label>Quote</label>
              <div>Price: <span class="pf-green" id="pf-trade-price">{{ '%.6f'|format(token.price or 0) }}</span></div>
              <div>Total: <span class="pf-green" id="pf-trade-total">0.000000</span></div>
            </div>
            <button class="retro-button" type="submit">Review</button>
          </form>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Overview</h2>
    <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <div>Symbol: <strong>{{ token.symbol }}</strong></div>
      <div>Name: <span class="pf-green">{{ token.name }}</span></div>
      <div>Price: <span class="pf-green">{{ '%.6f'|format(token.price or 0) }}</span></div>
      <div>Market Cap: <span class="pf-green">{{ '%.2f'|format(token.market_cap or 0) }}</span></div>
      <div>24h Change: <span class="pf-green">{{ '%.2f'|format(token.change_24h or 0) }}%</span></div>
    </div>
  </section>
{% endblock %}
