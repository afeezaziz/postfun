{% extends 'base.html' %}
{% block title %}{{ token.symbol }} Pool | Postfun{% endblock %}
{% block content %}
  <section class="card" data-sse-symbol="{{ token.symbol }}">
    <h1>
      <span class="badge">{{ token.symbol }}</span>
      {{ token.name }}
    </h1>
    <div class="pf-grid" style="grid-template-columns: 2fr 1fr;">
      <div class="card">
        <div class="pf-tabs" data-tabs>
          <div class="pf-tab-list">
            <button class="pf-tab pf-tab-active" data-tab-target="chart">Chart</button>
            <button class="pf-tab" data-tab-target="holders">Holders</button>
            <button class="pf-tab" data-tab-target="swaps">Swaps</button>
          </div>
          <div class="pf-tab-contents">
            <div class="pf-tab-content pf-tab-content-active" data-tab-content="chart">
              <div class="pf-chart" id="pf-chart" data-series='{{ series | tojson }}'>
                <div class="pf-chart-toolbar" style="display:flex; align-items:center; justify-content: space-between; gap: 12px; margin-bottom: 8px;">
                  <div class="pf-chart-modes" style="display:flex; gap:8px;">
                    <button class="retro-button pf-active" data-chart-mode="line">Line</button>
                    <button class="retro-button" data-chart-mode="candle">Candles</button>
                  </div>
                  <div class="pf-chart-controls" style="display:flex; align-items:center; gap:8px;">
                    <label for="pf-interval" style="font-size: 12px; color: var(--dim-green);">Interval</label>
                    <select id="pf-interval" class="retro-input" data-chart-interval>
                      <option value="1m" selected>1m</option>
                      <option value="5m">5m</option>
                      <option value="1h">1h</option>
                    </select>
                    <button class="retro-button" data-chart-refresh>Refresh</button>
                  </div>
                </div>
                <svg class="pf-chart-svg" width="100%" height="160" preserveAspectRatio="none">
                  <path class="pf-chart-path" d="" fill="none" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
              <div style="display:flex; justify-content: space-between; font-size: 14px; color: var(--dim-green);">
                <span>Min: <span id="pf-chart-min">—</span></span>
                <span>Max: <span id="pf-chart-max">—</span></span>
              </div>
            </div>
            <div class="pf-tab-content" data-tab-content="holders">
              <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                {% for h in holders %}
                  <div class="card">
                    <div>#{{ h.rank }} — <span class="pf-green">{{ h.address }}</span></div>
                    <div>Amount: <span class="pf-green">{{ '%.4f'|format(h.amount) }}</span></div>
                  </div>
                {% else %}
                  <div>No holders yet.</div>
                {% endfor %}
              </div>
            </div>
            <div class="pf-tab-content" data-tab-content="swaps">
              <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                {% for t in trades %}
                  <div class="card">
                    <div>{{ t.created_at }}</div>
                    <div>Side: <span class="pf-green">{{ t.side }}</span></div>
                    <div>In: <span class="pf-green">{{ '%.6f'|format(t.amount_in) }}</span></div>
                    <div>Out: <span class="pf-green">{{ '%.6f'|format(t.amount_out) }}</span></div>
                    {% if t.price is not none %}
                      <div>Price: <span class="pf-green">{{ '%.6f'|format(t.price) }}</span></div>
                    {% endif %}
                    <div>Stage: <span class="pf-green">{{ t.stage }}</span></div>
                  </div>
                {% else %}
                  <div>No swaps yet.</div>
                {% endfor %}
              </div>
            </div>
        </div>
      </div>

      <div class="card">
        <h2>Trade {{ token.symbol }}</h2>
        <form method="POST" action="{{ url_for('web.pool_trade', symbol=token.symbol) }}" id="pf-trade-form" data-price="{{ '%.6f'|format((price or 0) if price is not none else (token.price or 0)) }}" data-symbol="{{ token.symbol }}">
          <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
          <input type="hidden" name="min_amount_out" id="pf-min-amount-out" />
          <input type="hidden" name="max_slippage_bps" id="pf-max-slippage-bps" value="{{ default_slippage_bps }}" />
          <div style="margin-bottom:8px;">
            <label style="display:inline-flex; align-items:center; gap: 8px;">
              <input type="radio" name="side" value="buy" checked/> Buy
            </label>
            <label style="display:inline-flex; align-items:center; gap: 8px; margin-left: 12px;">
              <input type="radio" name="side" value="sell"/> Sell
            </label>
          </div>
          <div style="margin-bottom:8px;">
            <label>Amount (you pay)</label>
            <input class="retro-input" type="text" name="amount" placeholder="e.g. 10" />
          </div>
          <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
            <label for="pf-slippage-bps" title="Maximum slippage tolerance (basis points)">Slippage</label>
            <input class="retro-input" style="width:90px;" id="pf-slippage-bps" type="number" min="0" max="5000" step="1" value="{{ default_slippage_bps }}" />
            <span class="pf-green" style="font-size:12px;">bps</span>
          </div>
          <div style="margin-bottom:8px;">
            <label>Quote</label>
            <div>Exec Price: <span class="pf-green" id="pf-trade-price" data-price-target>{{ '%.6f'|format((price or 0) if price is not none else (token.price or 0)) }}</span></div>
            <div>You receive: <span class="pf-green" id="pf-trade-total">0.000000</span></div>
            <div>Price Impact: <span class="pf-green" id="pf-trade-impact">—</span></div>
            <div>Fee: <span class="pf-green" id="pf-trade-fee">—</span> (bps: <span class="pf-green" id="pf-trade-fee-bps">{{ pool.current_fee_bps() if pool else 0 }}</span>)</div>
            <div>Stage: <span class="pf-green" id="pf-trade-stage">{{ pool.stage if pool else 1 }}</span></div>
            <div id="pf-trade-warn" style="margin-top:6px; color:#cc3333; font-size:12px;"></div>
          </div>
          <button class="retro-button" type="submit">Swap</button>
        </form>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          {% if current_user %}
            {% if watchlisted %}
              <form method="POST" action="{{ url_for('web.watchlist_remove', symbol=token.symbol, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
                <button class="retro-button" type="submit">Remove from Watchlist</button>
              </form>
            {% else %}
              <form method="POST" action="{{ url_for('web.watchlist_add', symbol=token.symbol, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
                <button class="retro-button" type="submit">Add to Watchlist</button>
              </form>
            {% endif %}
            <a class="retro-button" href="{{ url_for('web.alerts') }}">Alerts</a>
          {% else %}
            <button class="retro-button" onclick="pfNostrLogin()">Login to use Watchlist & Alerts</button>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <div>Symbol: <strong>{{ token.symbol }}</strong></div>
      <div>Name: <span class="pf-green">{{ token.name }}</span></div>
      <div>Price: <span class="pf-green" data-price-target>{{ '%.6f'|format((price or 0) if price is not none else (token.price or 0)) }}</span></div>
      <div>Market Cap: <span class="pf-green">{{ '%.2f'|format(token.market_cap or 0) }}</span></div>
      <div>24h Change: <span class="pf-green">{{ '%.2f'|format(token.change_24h or 0) }}%</span></div>
      {% if launcher %}
      <div>Creator: <a class="pf-green" href="{{ url_for('web.creator_profile', user_id=launcher.id) }}">{{ launcher.npub or launcher.pubkey_hex }}</a></div>
      {% endif %}
    </div>
  </section>

  {% if fee_summary %}
  <section class="card">
    <h2>Protocol Fee Summary</h2>
    <div class="pf-table-wrap">
      <table class="pf-table">
        <thead>
          <tr>
            <th>Entity</th>
            <th>Alloc A</th>
            <th>Alloc B</th>
            <th>Paid A</th>
            <th>Paid B</th>
            <th>Pending A</th>
            <th>Pending B</th>
          </tr>
        </thead>
        <tbody>
          {% for key in ['creator','minter','treasury'] %}
            {% set row = fee_summary.get(key) %}
            {% if row %}
            <tr>
              <td><strong>{{ key|capitalize }}</strong></td>
              <td>{{ '%.8f'|format(row.alloc['A'] or 0) }}</td>
              <td>{{ '%.8f'|format(row.alloc['B'] or 0) }}</td>
              <td>{{ '%.8f'|format(row.paid['A'] or 0) }}</td>
              <td>{{ '%.8f'|format(row.paid['B'] or 0) }}</td>
              <td>{{ '%.8f'|format(row.pending['A'] or 0) }}</td>
              <td>{{ '%.8f'|format(row.pending['B'] or 0) }}</td>
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}
{% endblock %}
