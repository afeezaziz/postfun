{% extends 'base.html' %}
{% block title %}Token – {{ token.symbol }} | Postfun{% endblock %}
{% block meta %}
  {{ super() }}
  {% if jsonld %}
  <script type="application/ld+json">{{ jsonld|tojson }}</script>
  {% endif %}
{% endblock %}
{% block content %}
  <section class="card" data-sse-symbol="{{ token.symbol }}">
    <h1>Token: <span class="badge">{{ token.symbol }}</span></h1>
    <div class="pf-grid pf-token-detail">
      <div class="card pf-token-panel">
        <h2>Chart</h2>
        <div class="pf-chart" id="pf-chart" data-series='[]'>
          <div class="pf-chart-toolbar" style="display:flex; align-items:center; justify-content: space-between; gap: 12px; margin-bottom: 8px;">
            <div class="pf-chart-modes" style="display:flex; gap:8px;">
              <button class="retro-button pf-active" data-chart-mode="line">Line</button>
              <button class="retro-button" data-chart-mode="candle">Candles</button>
            </div>
            <div class="pf-chart-controls" style="display:flex; align-items:center; gap:8px;">
              <label for="pf-interval" style="font-size: 12px; color: var(--dim-green);">Interval</label>
              <select id="pf-interval" class="retro-input" data-chart-interval>
                <option value="1m" selected>1m</option>
                <option value="5m">5m</option>
                <option value="1h">1h</option>
              </select>
              <button class="retro-button" data-chart-refresh>Refresh</button>
            </div>
          </div>
          <svg class="pf-chart-svg" width="100%" height="160" preserveAspectRatio="none">
            <path class="pf-chart-path" d="" fill="none" stroke="currentColor" stroke-width="2" />
          </svg>
        </div>
        <div style="display:flex; justify-content: space-between; font-size: 14px; color: var(--dim-green);">
          <span>Min: <span id="pf-chart-min">—</span></span>
          <span>Max: <span id="pf-chart-max">—</span></span>
        </div>
      </div>
      <div class="card pf-token-panel">
        <h2>Overview</h2>
        <div>Symbol: <strong>{{ token.symbol }}</strong></div>
        <div>Name: <span class="pf-green">{{ token.name }}</span></div>
        <div>Price: <span class="pf-green" data-price-target>{{ '%.4f'|format(price or 0) }}</span></div>
        <div>Market Cap: <span class="pf-green">{{ '%.2f'|format(token.market_cap or 0) }}</span></div>
        <div>24h Change: <span class="pf-green">{{ '%.2f'|format(token.change_24h or 0) }}%</span></div>
        {% if launcher %}
        <div>Creator: <a class="pf-green" href="{{ url_for('web.creator_profile', user_id=launcher.id) }}">{{ launcher.npub or launcher.pubkey_hex }}</a></div>
        {% if current_user and current_user.id != launcher.id %}
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          {% if is_following %}
            <form method="POST" action="{{ url_for('web.creator_unfollow', user_id=launcher.id) }}">
              <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
              <button class="retro-button" type="submit">Unfollow</button>
            </form>
          {% else %}
            <form method="POST" action="{{ url_for('web.creator_follow', user_id=launcher.id) }}">
              <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
              <button class="retro-button" type="submit">Follow</button>
            </form>
          {% endif %}
        </div>
        {% endif %}
        {% endif %}
      </div>
      <div class="card pf-token-panel">
        <h2>Activity</h2>
        <div>Recent trades</div>
        <ul>
          <li>—</li>
          <li>—</li>
          <li>—</li>
        </ul>
      </div>
      <div class="card pf-token-panel">
        <h2>Actions</h2>
        <a class="retro-button" href="{{ url_for('web.pool', symbol=token.symbol) }}">Go to Pool</a>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <a class="retro-button" href="#" data-share-url="{{ url_for('web.token_detail', symbol=token.symbol, _external=True) }}" data-share-text="Check out {{ token.symbol }} on Postfun">Share</a>
          <button class="retro-button" data-copy-url="{{ url_for('web.token_detail', symbol=token.symbol, _external=True) }}">Copy Link</button>
        </div>
        {% if not current_user %}
          <button class="retro-button" onclick="pfNostrLogin()">Login to Trade</button>
        {% else %}
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            {% if watchlisted %}
              <form method="POST" action="{{ url_for('web.watchlist_remove', symbol=token.symbol, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
                <button class="retro-button" type="submit">Remove from Watchlist</button>
              </form>
            {% else %}
              <form method="POST" action="{{ url_for('web.watchlist_add', symbol=token.symbol, next=request.path) }}">
                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
                <button class="retro-button" type="submit">Add to Watchlist</button>
              </form>
            {% endif %}
            <a class="retro-button" href="{{ url_for('web.watchlist') }}">View Watchlist</a>
          </div>
        {% endif %}
      </div>
      {% if fee_summary %}
      <div class="card pf-token-panel">
        <h2>Protocol Fee Summary</h2>
        <div class="pf-table-wrap">
          <table class="pf-table">
            <thead>
              <tr>
                <th>Entity</th>
                <th>Alloc A</th>
                <th>Alloc B</th>
                <th>Paid A</th>
                <th>Paid B</th>
                <th>Pending A</th>
                <th>Pending B</th>
              </tr>
            </thead>
            <tbody>
              {% for key in ['creator','minter','treasury'] %}
                {% set row = fee_summary.get(key) %}
                {% if row %}
                <tr>
                  <td><strong>{{ key|capitalize }}</strong></td>
                  <td>{{ '%.8f'|format(row.alloc['A'] or 0) }}</td>
                  <td>{{ '%.8f'|format(row.alloc['B'] or 0) }}</td>
                  <td>{{ '%.8f'|format(row.paid['A'] or 0) }}</td>
                  <td>{{ '%.8f'|format(row.paid['B'] or 0) }}</td>
                  <td>{{ '%.8f'|format(row.pending['A'] or 0) }}</td>
                  <td>{{ '%.8f'|format(row.pending['B'] or 0) }}</td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
  </section>
{% endblock %}
