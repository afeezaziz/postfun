{% extends 'base.html' %}
{% block title %}Wallet | Postfun{% endblock %}
{% block content %}
  <section class="card">
    <!-- Debug Info -->
    <div class="alert alert-info mb-4">
      <small>
        <strong>DEBUG:</strong> Page loaded at <span id="debug-time"></span> |
        Current balance: {{ user.sats // 1000 if user.sats else 0 }} sats |
        Invoices: {{ lightning_invoices|length }} | Withdrawals: {{ lightning_withdrawals|length }}
      </small>
    </div>

    <!-- Summary Section -->
    <div class="stats shadow">
      <div class="stat place-items-center">
        <div class="stat-title">Total Transactions</div>
        <div class="stat-value">{{ lightning_invoices|length + lightning_withdrawals|length }}</div>
        <div class="stat-desc">All transactions</div>
      </div>
      <div class="stat place-items-center">
        <div class="stat-title">Invoices</div>
        <div class="stat-value">{{ lightning_invoices|length }}</div>
        <div class="stat-desc">Created</div>
      </div>
      <div class="stat place-items-center">
        <div class="stat-title">Withdrawals</div>
        <div class="stat-value">{{ lightning_withdrawals|length }}</div>
        <div class="stat-desc">Sent</div>
      </div>
      <div class="stat place-items-center">
        <div class="stat-title">Balance</div>
        <div class="stat-value">{{ "{:,}".format(user.sats // 1000 if user.sats else 0) }}</div>
        <div class="stat-desc">Sats</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="flex justify-center gap-6 my-8">
      <button class="btn btn-lg btn-primary shadow-lg" onclick="openReceiveModal()">
        <span class="mr-2">‚ö°</span> Receive Lightning
      </button>
      <button class="btn btn-lg btn-secondary shadow-lg" onclick="openSendModal()">
        <span class="mr-2">üì§</span> Send Lightning
      </button>
      <button class="btn btn-lg btn-accent shadow-lg" onclick="checkPendingTransactions()">
        <span class="mr-2">üîÑ</span> Refresh Status
      </button>
    </div>

    <!-- Lightning Transactions Table -->
    {% if lightning_invoices or lightning_withdrawals %}
      <div class="overflow-x-auto">
        <div class="flex justify-between items-center mb-4 px-4 py-2 bg-base-200 rounded-lg">
          <span class="text-sm">Lightning Transactions</span>
          <span class="text-sm">{{ lightning_invoices|length + lightning_withdrawals|length }} total</span>
        </div>

        <table class="table table-xs">
          <thead>
            <tr>
              <th>Type</th>
              <th>Status</th>
              <th>Amount (sats)</th>
              <th>Date</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Invoices -->
            {% for invoice in lightning_invoices %}
              <tr>
                <td>
                  <span class="badge badge-success">Invoice</span>
                </td>
                <td>
                  <span class="badge badge-{{
                    'success' if invoice.status == 'paid'
                    else 'warning' if invoice.status == 'pending'
                    else 'error' if invoice.status == 'expired'
                    else 'error' if invoice.status == 'failed'
                    else 'neutral'
                  }}">
                    {% if invoice.status == 'paid' %}‚úÖ {% endif %}
                    {% if invoice.status == 'pending' %}‚è≥ {% endif %}
                    {% if invoice.status == 'expired' %}‚è∞ {% endif %}
                    {% if invoice.status == 'failed' %}‚ùå {% endif %}
                    {{ invoice.status|title }}
                  </span>
                </td>
                <td class="font-bold text-green-600">+{{ invoice.amount_sats }}</td>
                <td>{{ invoice.created_at.strftime('%Y-%m-%d %H:%M') if invoice.created_at.__class__.__name__ == 'datetime' else invoice.created_at }}</td>
                <td>
                  {% if invoice.memo %}
                    {{ invoice.memo }}
                  {% else %}
                    <span class="text-gray-400">No description</span>
                  {% endif %}
                </td>
                <td>
                  <div class="flex gap-1">
                    {% if invoice.status == 'pending' %}
                      <button class="btn btn-xs" onclick="copyInvoice('{{ invoice.payment_request }}')" title="Copy Invoice">
                        üìã
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}

            <!-- Withdrawals -->
            {% for withdrawal in lightning_withdrawals %}
              <tr>
                <td>
                  <span class="badge badge-error">Withdrawal</span>
                </td>
                <td>
                  <span class="badge badge-{{
                    'success' if withdrawal.status == 'confirmed'
                    else 'warning' if withdrawal.status == 'pending'
                    else 'error' if withdrawal.status == 'expired'
                    else 'error' if withdrawal.status == 'failed'
                    else 'neutral'
                  }}">
                    {% if withdrawal.status == 'confirmed' %}‚úÖ {% endif %}
                    {% if withdrawal.status == 'pending' %}‚è≥ {% endif %}
                    {% if withdrawal.status == 'expired' %}‚è∞ {% endif %}
                    {% if withdrawal.status == 'failed' %}‚ùå {% endif %}
                    {{ withdrawal.status|title }}
                  </span>
                </td>
                <td class="font-bold text-red-600">-{{ withdrawal.amount_sats }}</td>
                <td>{{ withdrawal.created_at.strftime('%Y-%m-%d %H:%M') if withdrawal.created_at.__class__.__name__ == 'datetime' else withdrawal.created_at }}</td>
                <td>
                  {% if withdrawal.fee_sats %}
                    Fee: {{ withdrawal.fee_sats }} sats
                  {% else %}
                    <span class="text-gray-400">Lightning payment</span>
                  {% endif %}
                </td>
                <td>
                  <div class="flex gap-1">
                    <!-- No actions for withdrawals -->
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th>Type</th>
              <th>Status</th>
              <th>Amount (sats)</th>
              <th>Date</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </tfoot>
        </table>
      </div>
    {% else %}
      <div class="card bg-base-200">
        <div class="card-body text-center">
          <div class="text-6xl mb-4">‚ö°</div>
          <h3 class="text-xl font-bold mb-2">No Lightning Activity Yet</h3>
          <p class="text-gray-600 mb-6">Start by receiving your first lightning payment</p>
          <button class="btn btn-primary" onclick="openReceiveModal()">Receive Lightning</button>
        </div>
      </div>
    {% endif %}
  </section>


  <!-- Receive Lightning Modal -->
  <dialog id="receiveModal" class="modal">
    <div class="modal-box bg-terminal-black border-2 border-terminal-green">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-terminal-green font-bold text-lg">‚ö° Receive Lightning</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle border-terminal-green text-terminal-green hover:bg-terminal-green hover:text-terminal-black">‚úï</button>
        </form>
      </div>
      <form id="receiveForm" onsubmit="createInvoice(event)">
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text text-terminal-green">Amount (sats):</span>
          </label>
          <input type="number" id="receiveAmount" name="amount" min="100" max="1000000" required
                 class="terminal-input input-bordered w-full" placeholder="Minimum: 100 sats" />
          <div id="amountError" class="text-terminal-red text-sm mt-1 hidden"></div>
          <div class="text-terminal-dim-green text-xs mt-1">Recommended: 1,000 - 100,000 sats</div>
        </div>
        <div class="form-control mb-6">
          <label class="label">
            <span class="label-text text-terminal-green">Memo (optional):</span>
          </label>
          <input type="text" id="receiveMemo" name="memo" maxlength="255"
                 class="terminal-input input-bordered w-full" placeholder="Add a note..." />
        </div>
        <div class="modal-action">
          <button type="submit" class="terminal-button" id="createInvoiceBtn">Create Invoice</button>
          <button type="button" class="terminal-button" onclick="closeReceiveModal()">Cancel</button>
        </div>
      </form>
      <div id="invoiceResult" class="hidden">
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text text-terminal-green">Invoice:</span>
          </label>
          <textarea id="invoiceText" readonly rows="3"
                    class="terminal-input input-bordered w-full font-terminal"></textarea>
        </div>
        <div class="form-control mb-6">
          <label class="label">
            <span class="label-text text-terminal-green">QR Code:</span>
          </label>
          <div id="invoiceQR" class="terminal-card border-2 border-terminal-green p-4 text-center"></div>
        </div>
        <div class="modal-action">
          <button class="terminal-button" onclick="copyInvoice(document.getElementById('invoiceText').value)">Copy</button>
          <form method="dialog">
            <button class="terminal-button">Close</button>
          </form>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Send Lightning Modal -->
  <dialog id="sendModal" class="modal">
    <div class="modal-box bg-terminal-black border-2 border-terminal-green">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-terminal-green font-bold text-lg">üì§ Send Lightning</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle border-terminal-green text-terminal-green hover:bg-terminal-green hover:text-terminal-black">‚úï</button>
        </form>
      </div>
      <form id="sendForm" onsubmit="sendPayment(event)">
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text text-terminal-green">Lightning Invoice:</span>
          </label>
          <textarea id="sendInvoice" name="invoice" rows="3" required
                    placeholder="lnbc..."
                    class="terminal-input input-bordered w-full font-terminal"></textarea>
          <div id="invoiceError" class="text-terminal-red text-sm mt-1 hidden"></div>
          <div class="text-terminal-dim-green text-xs mt-1">Paste a lightning invoice starting with 'lnbc'</div>
        </div>
        <div class="form-control mb-6">
          <label class="label">
            <span class="label-text text-terminal-green">Amount (sats):</span>
          </label>
          <input type="number" id="sendAmount" name="amount" readonly
                 class="terminal-input input-bordered w-full" />
          <div id="amountDisplay" class="text-terminal-dim-green text-xs mt-1">Amount will be extracted from invoice</div>
        </div>
        <div class="modal-action">
          <button type="submit" class="terminal-button" id="sendPaymentBtn">Send Payment</button>
          <button type="button" class="terminal-button" onclick="closeSendModal()">Cancel</button>
        </div>
      </form>
      <div id="sendResult" class="hidden terminal-card border-terminal-green p-4 mt-4 text-center">
        <!-- Send result will be displayed here -->
      </div>
    </div>
  </dialog>

  <!-- QR Code Modal -->
  <dialog id="qrModal" class="modal">
    <div class="modal-box bg-terminal-black border-2 border-terminal-green">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-terminal-green font-bold text-lg">üì± QR Code</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle border-terminal-green text-terminal-green hover:bg-terminal-green hover:text-terminal-black">‚úï</button>
        </form>
      </div>
      <div id="qrCode" class="terminal-card border-2 border-terminal-green p-4 text-center mb-6"></div>
      <div class="modal-action">
        <form method="dialog">
          <button class="terminal-button">Close</button>
        </form>
      </div>
    </div>
  </dialog>

  <style>
    /* Terminal-style wallet using existing design system */

    /* Larger modal styling */
    .modal-box {
      max-width: 600px !important;
      width: 90vw !important;
      padding: 2rem !important;
    }

    /* Make modal content areas more spacious */
    .modal-box .form-control {
      margin-bottom: 1.5rem !important;
    }

    /* Larger text areas for better readability */
    .modal-box textarea {
      min-height: 120px !important;
      font-size: 14px !important;
    }

    /* Bigger modal action buttons */
    .modal-action {
      gap: 1rem !important;
    }

    .modal-action .terminal-button {
      min-width: 120px !important;
      padding: 0.75rem 1.5rem !important;
      font-size: 16px !important;
    }
    .pf-wallet-header {
      @apply terminal-card mb-6 flex justify-between items-center;
    }

    .pf-wallet-title h1 {
      @apply text-terminal-green text-3xl font-normal mb-2;
    }

    .pf-wallet-subtitle {
      @apply text-terminal-gray;
    }

    .pf-wallet-balance-card {
      @apply text-center min-w-[200px];
    }

    .pf-balance-label {
      @apply text-terminal-gray text-xs uppercase tracking-widest mb-2;
    }

    .pf-balance-amount {
      @apply text-terminal-green text-2xl font-normal mb-1;
    }

    .pf-bance-details {
      @apply text-terminal-gray text-sm;
    }

    .pf-quick-actions {
      @apply flex gap-4 mb-6 justify-center;
    }

    .pf-action-btn {
      @apply terminal-card flex flex-col items-center gap-2 min-w-[100px] p-3 cursor-pointer transition-all;
    }

    .pf-action-btn:hover {
      @apply bg-[#001a00];
    }

    .pf-btn-icon {
      @apply text-xl;
    }

    .pf-btn-text {
      @apply text-terminal-green font-normal;
    }

    .pf-section {
      @apply terminal-card mb-6;
    }

    .pf-section-header {
      @apply flex justify-between items-center mb-4 pb-2 border-b border-terminal-green;
    }

    .pf-section-header h2 {
      @apply text-terminal-yellow text-xl font-normal m-0;
    }

    .pf-section-badge {
      @apply terminal-badge;
    }

    .pf-activity-list {
      @apply flex flex-col gap-3;
    }

    .pf-activity-item {
      @apply terminal-card flex items-start gap-3 p-3 transition-all;
    }

    .pf-activity-item:hover {
      @apply border-terminal-gray;
    }

    .pf-incoming {
      @apply border-l-4 border-l-terminal-green;
    }

    .pf-outgoing {
      @apply border-l-4 border-l-terminal-red;
    }

    .pf-activity-icon {
      @apply text-lg mt-1;
    }

    .pf-activity-content {
      @apply flex-1;
    }

    .pf-activity-header {
      @apply flex justify-between items-center mb-1;
    }

    .pf-activity-type {
      @apply font-normal text-terminal-green;
    }

    .pf-activity-amount {
      @apply font-normal;
    }

    .pf-incoming .pf-activity-amount {
      @apply text-terminal-green;
    }

    .pf-outgoing .pf-activity-amount {
      @apply text-terminal-red;
    }

    .pf-activity-details {
      @apply flex items-center gap-2 text-sm;
    }

    .pf-activity-time {
      @apply text-terminal-gray;
    }

    .pf-activity-fee {
      @apply text-terminal-gray text-sm mt-1;
    }

    .pf-activity-actions {
      @apply flex gap-2 mt-2;
    }

    .pf-tiny-btn {
      @apply terminal-button text-xs py-1 px-2;
    }

    .pf-transaction-grid {
      @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4;
    }

    .pf-transaction-card {
      @apply terminal-card overflow-hidden;
    }

    .pf-transaction-header {
      @apply terminal-card flex justify-between items-center p-3 border-b border-terminal-green;
    }

    .pf-tx-type {
      @apply flex items-center gap-2 font-normal;
    }

    .pf-tx-invoice {
      @apply text-terminal-green;
    }

    .pf-tx-withdrawal {
      @apply text-terminal-red;
    }

    .pf-tx-amount {
      @apply font-normal text-lg;
    }

    .pf-invoice-card .pf-tx-amount {
      @apply text-terminal-green;
    }

    .pf-withdrawal-card .pf-tx-amount {
      @apply text-terminal-red;
    }

    .pf-transaction-body {
      @apply p-4;
    }

    .pf-tx-hash, .pf-tx-memo, .pf-tx-fee {
      @apply flex justify-between items-center mb-2 text-sm;
    }

    .pf-tx-label {
      @apply text-terminal-gray;
    }

    .pf-tx-value {
      @apply text-terminal-green;
    }

    .pf-tx-meta {
      @apply flex justify-between items-center mt-3 pt-2 border-t border-terminal-green;
    }

    .pf-tx-date {
      @apply text-terminal-gray text-xs;
    }

    .pf-transaction-actions {
      @apply flex gap-2 mt-3;
    }

    .pf-action-button {
      @apply terminal-button text-sm;
    }

    .pf-empty-state {
      @apply text-center p-10 text-terminal-gray;
    }

    .pf-empty-icon {
      @apply text-4xl mb-4 opacity-50;
    }

    .pf-empty-text {
      @apply mb-4 text-lg;
    }

    .pf-empty-action {
      @apply terminal-button;
    }

    .badge {
      @apply terminal-badge text-xs;
    }

    .badge-pending {
      @apply border-terminal-yellow text-terminal-yellow;
    }

    .badge-paid {
      @apply border-terminal-green text-terminal-green;
    }

    .badge-expired {
      @apply border-terminal-gray text-terminal-gray;
    }

    .badge-cancelled {
      @apply border-terminal-red text-terminal-red;
    }

    .badge-confirmed {
      @apply border-terminal-green text-terminal-green;
    }

    .badge-failed {
      @apply border-terminal-red text-terminal-red;
    }

    .pf-monospace {
      @apply font-terminal text-terminal-green bg-transparent px-1 py-0.5 border border-terminal-green rounded text-sm;
    }

    /* Modal styles using terminal classes */
    .pf-modal {
      @apply fixed inset-0 bg-terminal-black bg-opacity-95 flex items-center justify-center z-50;
    }

    .pf-modal-content {
      @apply terminal-card w-full max-w-md max-h-[90vh] overflow-y-auto;
    }

    .pf-modal-header {
      @apply terminal-card flex justify-between items-center p-4 border-b border-terminal-green mb-0;
    }

    .pf-modal-header h3 {
      @apply text-terminal-yellow text-xl font-normal m-0;
    }

    .pf-modal-body {
      @apply p-6 text-terminal-green;
    }

    .pf-modal-close {
      @apply text-terminal-gray text-2xl cursor-pointer transition-all hover:text-terminal-red;
    }

    .pf-form-group {
      @apply mb-4;
    }

    .pf-form-group label {
      @apply block mb-2 font-normal text-terminal-green;
    }

    .pf-form-actions {
      @apply flex gap-3 justify-end mt-6;
    }

    #invoiceText {
      @apply terminal-input font-terminal text-terminal-green min-h-[80px] resize-y;
    }

    #invoiceQR,
    #qrCode {
      @apply terminal-card p-4 text-center my-4;
    }

    #sendResult {
      @apply terminal-card border-terminal-green p-4 mt-4 text-center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .pf-wallet-header {
        @apply flex-col gap-4 text-center;
      }

      .pf-quick-actions {
        @apply flex-col items-center;
      }

      .pf-transaction-grid {
        @apply grid-cols-1;
      }
    }
  </style>

  <script>
    function openReceiveModal() {
      document.getElementById('receiveModal').showModal();
    }

    function closeReceiveModal() {
      document.getElementById('receiveModal').close();
      document.getElementById('receiveForm').reset();
      document.getElementById('invoiceResult').classList.add('hidden');
    }

    function openSendModal() {
      document.getElementById('sendModal').showModal();
    }

    function closeSendModal() {
      document.getElementById('sendModal').close();
      document.getElementById('sendForm').reset();
      document.getElementById('sendResult').classList.add('hidden');
    }

    function closeQRModal() {
      document.getElementById('qrModal').close();
      document.getElementById('qrCode').innerHTML = '';
    }

    function copyInvoice(invoice) {
      navigator.clipboard.writeText(invoice).then(() => {
        showNotification('Invoice copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy invoice', 'error');
      });
    }

    function showQR(invoice) {
      // Simple QR code display (you can use a proper QR library)
      document.getElementById('qrCode').innerHTML =
        `<div class="text-center p-4">
          <div class="font-terminal text-xs break-all p-2 border border-terminal-green bg-terminal-black">${invoice}</div>
          <p class="text-terminal-dim-green mt-2 text-sm">Invoice text (scan with a QR code reader)</p>
        </div>`;
      document.getElementById('qrModal').showModal();
    }

    function validateAmount(amount) {
      const amountNum = parseInt(amount);
      if (isNaN(amountNum) || amountNum < 100) {
        return { valid: false, error: 'Minimum amount is 100 sats' };
      }
      if (amountNum > 1000000) {
        return { valid: false, error: 'Maximum amount is 1,000,000 sats' };
      }
      return { valid: true };
    }

    function validateInvoice(invoice) {
      if (!invoice || typeof invoice !== 'string') {
        return { valid: false, error: 'Invoice is required' };
      }
      if (!invoice.startsWith('lnbc')) {
        return { valid: false, error: 'Invoice must start with lnbc' };
      }
      if (invoice.length < 100) {
        return { valid: false, error: 'Invoice appears to be too short' };
      }
      return { valid: true };
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      errorElement.classList.add('hidden');
    }

    function setLoading(buttonId, isLoading) {
      const button = document.getElementById(buttonId);
      if (isLoading) {
        button.disabled = true;
        button.textContent = 'Processing...';
      } else {
        button.disabled = false;
        button.textContent = buttonId === 'createInvoiceBtn' ? 'Create Invoice' : 'Send Payment';
      }
    }

    // Helper function to create and sign Nostr event for authentication
    async function createNostrAuthEvent() {
      try {
        console.log('Creating Nostr auth event...');

        // Check for Nostr provider (supports both standard Nostr and OKX wallet)
        let nostrProvider = null;

        console.log('Checking for window.nostr:', !!window.nostr);
        console.log('Checking for window.okxwallet:', !!window.okxwallet);
        console.log('Checking for window.okxwallet.nostr:', !!window.okxwallet?.nostr);

        if (window.nostr && window.nostr.getPublicKey && window.nostr.signEvent) {
          nostrProvider = window.nostr;
          console.log('Using standard Nostr provider');
        } else if (window.okxwallet && window.okxwallet.nostr && window.okxwallet.nostr.getPublicKey && window.okxwallet.nostr.signEvent) {
          nostrProvider = window.okxwallet.nostr;
          console.log('Using OKX wallet Nostr provider');
        } else {
          console.error('Nostr provider not found');
          throw new Error('Nostr provider not available. Please connect a Nostr wallet like Alby, nos2x, or OKX wallet.');
        }

        console.log('Getting public key from Nostr provider...');
        const pubkey = await nostrProvider.getPublicKey();
        console.log('Got pubkey:', pubkey);

        const content = JSON.stringify({
          action: 'lightning_invoice',
          domain: 'postfun',
          exp: Math.floor(Date.now() / 1000) + 300  // 5 minutes expiration
        });

        const event = {
          kind: 27235,  // NIP-42 authentication
          content,
          tags: [],
          created_at: Math.floor(Date.now() / 1000),
          pubkey
        };

        console.log('Created Nostr event, signing...');
        const signed = await nostrProvider.signEvent(event);
        console.log('Event signed successfully');

        // Base64 encode the signed event
        const eventJson = JSON.stringify(signed);
        const eventBase64 = btoa(eventJson);
        console.log('Base64 encoded event length:', eventBase64.length);

        return eventBase64;
      } catch (error) {
        console.error('Error creating Nostr auth event:', error);
        return null;
      }
    }

    async function createInvoice(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const amount = formData.get('amount');
      const memo = formData.get('memo') || '';

      // Validate amount
      hideError('amountError');
      const validation = validateAmount(amount);
      if (!validation.valid) {
        showError('amountError', validation.error);
        return;
      }

      setLoading('createInvoiceBtn', true);

      try {
        // Create Nostr authentication event
        const nostrAuth = await createNostrAuthEvent();
        if (!nostrAuth) {
          showError('amountError', 'Nostr authentication failed. Please ensure your Nostr wallet is connected.');
          return;
        }

        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Nostr ${nostrAuth}`
        };

        console.log('Creating invoice with Nostr authentication...');
        const response = await fetch('/api/lightning/invoice', {
          method: 'POST',
          headers,
          body: JSON.stringify({
            amount: parseInt(amount),
            memo: memo
          })
        });

        const result = await response.json();

        console.log('Create invoice response status:', response.status);
        console.log('Create invoice response body:', result);

        if (response.ok) {
          // Show success notification and refresh page
          showNotification('Invoice created successfully!', 'success');
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          showError('amountError', result.error || 'Failed to create invoice');
        }
      } catch (error) {
        showError('amountError', 'Network error: ' + error.message);
      } finally {
        setLoading('createInvoiceBtn', false);
      }
    }

    // Improved invoice decoder to extract amount, description (memo), expiry, and payee pubkey
    function decodeInvoice(invoice) {
      try {
        if (!invoice || !invoice.startsWith('lnbc')) {
          return null;
        }

        // Extract amount from bech32 string
        let amount = null;
        let amountMultiplier = 1;

        // Extract amount part after lnbc
        const amountMatch = invoice.match(/^lnbc([0-9]+)([munp]?)1/);
        if (amountMatch) {
          amount = parseInt(amountMatch[1]);
          const multiplier = amountMatch[2];

          // Handle multipliers correctly (m = milli, u = micro, n = nano, p = pico)
          switch (multiplier) {
            case 'm': amountMultiplier = 0.001; break;
            case 'u': amountMultiplier = 0.000001; break;
            case 'n': amountMultiplier = 0.000000001; break;
            case 'p': amountMultiplier = 0.000000000001; break;
            default: amountMultiplier = 1;
          }

          amount = Math.round(amount * amountMultiplier * 100000000); // Convert to sats
        }

        // Extract description (memo) from lightning invoice
        // Lightning invoices use 'd' field for description/description_hash
        let description = 'Lightning payment';

        // Look for description field pattern (simplified approach)
        // In real lightning invoices, description is encoded in the bech32 string
        const descMatch = invoice.match(/[^\d]+[a-z]/);
        if (descMatch) {
          try {
            // Try to extract readable text from the human-readable part
            const hrp = invoice.split('1')[0]; // Human-readable part
            if (hrp.length > 4) {
              const potentialDesc = hrp.substring(4).replace(/[0-9]/g, '');
              if (potentialDesc.length > 0) {
                description = potentialDesc;
              }
            }
          } catch (e) {
            console.log('Could not parse description from invoice');
          }
        }

        // Extract expiry (typically 3600 seconds = 1 hour by default)
        let expiry = 3600; // Default 1 hour

        // Look for expiry patterns in the data part
        const dataPart = invoice.split('1')[1] || '';
        const expiryPatterns = dataPart.match(/\d+/g);
        if (expiryPatterns && expiryPatterns.length > 1) {
          // The second number might be expiry
          const potentialExpiry = parseInt(expiryPatterns[1]);
          if (potentialExpiry > 0 && potentialExpiry < 1000000) {
            expiry = potentialExpiry;
          }
        }

        // Extract payee pubkey (simplified - would require proper bech32 decoding)
        let payeePubkey = '';
        const dataParts = dataPart.match(/[02-9ac-hj-np-z]+/g);
        if (dataParts && dataParts.length > 0) {
          payeePubkey = dataParts[0].substring(0, 32);
        }

        return {
          amount: amount,
          description: description,
          expiry: expiry,
          payeePubkey: payeePubkey || 'Unknown'
        };
      } catch (e) {
        console.error('Error decoding invoice:', e);
        return null;
      }
    }

    // Add real-time invoice validation
    document.addEventListener('DOMContentLoaded', function() {
      const invoiceInput = document.getElementById('sendInvoice');
      const amountInput = document.getElementById('sendAmount');
      const amountDisplay = document.getElementById('amountDisplay');

      invoiceInput.addEventListener('input', function() {
        const invoice = this.value.trim();
        hideError('invoiceError');

        if (invoice) {
          const validation = validateInvoice(invoice);
          if (!validation.valid) {
            showError('invoiceError', validation.error);
            amountInput.value = '';
            amountDisplay.textContent = 'Invalid invoice format';
            return;
          }

          const decoded = decodeInvoice(invoice);
          if (decoded && decoded.amount) {
            amountInput.value = decoded.amount;
            amountDisplay.textContent = `Amount: ${decoded.amount.toLocaleString()} sats | Description: ${decoded.description} | Expires: ${decoded.expiry}s`;
            amountDisplay.className = 'text-terminal-green text-xs mt-1';
          } else {
            amountInput.value = '';
            amountDisplay.textContent = 'Amount not specified in invoice';
            amountDisplay.className = 'text-terminal-yellow text-xs mt-1';
          }
        } else {
          amountInput.value = '';
          amountDisplay.textContent = 'Amount will be extracted from invoice';
          amountDisplay.className = 'text-terminal-dim-green text-xs mt-1';
        }
      });

      // Add real-time amount validation
      const amountInput2 = document.getElementById('receiveAmount');
      amountInput2.addEventListener('input', function() {
        hideError('amountError');
        const amount = this.value;
        if (amount) {
          const validation = validateAmount(amount);
          if (!validation.valid) {
            showError('amountError', validation.error);
          }
        }
      });

      // Add page load debug message
      console.log('[DEBUG] Wallet page loaded at', new Date().toISOString());
      var userBalance = {{ user.sats // 1000 if user.sats else 0 }};
      console.log('[DEBUG] User balance displayed:', userBalance, 'sats');

      // Update debug info on page
      document.getElementById('debug-time').textContent = new Date().toLocaleString();

      // Removed automatic check to prevent infinite refresh loop
      // Users can manually check by clicking the "üîÑ Refresh Status" button
    });

    async function sendPayment(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const invoice = formData.get('invoice');

      // Validate invoice
      hideError('invoiceError');
      const validation = validateInvoice(invoice);
      if (!validation.valid) {
        showError('invoiceError', validation.error);
        return;
      }

      setLoading('sendPaymentBtn', true);

      try {
        console.log('Sending withdrawal request (simple approach)...');

        // Create form data for simple web route
        const formData = new FormData();
        formData.append('invoice', invoice);
        formData.append('amount_sats', parseInt(document.getElementById('sendAmount').value) || 0);

        const response = await fetch('/users/wallet/withdraw', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          document.getElementById('sendResult').innerHTML =
            `<div class="text-terminal-green p-4 border border-terminal-green rounded">
              <div class="text-lg font-bold mb-2">‚úì Payment Sent Successfully!</div>
              <div class="space-y-1">
                <div>Amount: ${result.amount_sats.toLocaleString()} sats</div>
                <div>Fee: ${result.fee_sats || 0} sats</div>
                <div>Payment Hash: ${result.payment_hash ? result.payment_hash.substring(0, 16) + '...' : 'N/A'}</div>
              </div>
              <div class="text-terminal-dim-green text-sm mt-3">Page will refresh in 3 seconds...</div>
            </div>`;
          document.getElementById('sendResult').classList.remove('hidden');

          // Refresh page after a delay
          setTimeout(() => {
            location.reload();
          }, 3000);
        } else {
          showError('invoiceError', result.error || 'Failed to send payment');
        }
      } catch (error) {
        showError('invoiceError', 'Network error: ' + error.message);
      } finally {
        setLoading('sendPaymentBtn', false);
      }
    }

    function copyPaymentHash(hash) {
      navigator.clipboard.writeText(hash).then(() => {
        showNotification('Payment hash copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy payment hash', 'error');
      });
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all transform translate-x-full ${
        type === 'success' ? 'bg-terminal-green text-terminal-black' :
        type === 'error' ? 'bg-terminal-red text-terminal-white' :
        'bg-terminal-yellow text-terminal-black'
      }`;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);

      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    async function checkPendingTransactions() {
      console.log('Refreshing page to check transaction status...');
      showNotification('üîÑ Refreshing transaction status...', 'info');

      // Simple page refresh - backend will automatically check pending transactions
      setTimeout(() => {
        location.reload();
      }, 1000);
    }

    async function cancelWithdrawal(withdrawalId) {
      if (!confirm('Are you sure you want to cancel this withdrawal?')) {
        return;
      }

      try {
        // Create Nostr authentication event
        const nostrAuth = await createNostrAuthEvent();
        if (!nostrAuth) {
          showNotification('Nostr authentication failed. Please ensure your Nostr wallet is connected.', 'error');
          return;
        }

        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Nostr ${nostrAuth}`
        };

        const response = await fetch(`/api/lightning/withdrawal/${withdrawalId}/cancel`, {
          method: 'POST',
          headers
        });

        const result = await response.json();

        if (response.ok) {
          showNotification('Withdrawal cancelled successfully!', 'success');
          location.reload();
        } else {
          showNotification('Error cancelling withdrawal: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('Error cancelling withdrawal: ' + error.message, 'error');
      }
    }
  </script>
{% endblock content %}