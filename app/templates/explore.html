{% extends 'base.html' %}
{% block title %}Explore | Postfun{% endblock %}
{% block content %}
  <section class="card">
    <h1>Explore</h1>
    <form method="GET" action="{{ url_for('web.explore') }}" class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); align-items: end;">
      <div>
        <label>Search</label>
        <input class="retro-input" type="text" name="q" value="{{ q }}" placeholder="symbol or name" />
      </div>
      <div>
        <label>Filter</label>
        <select class="retro-input" name="filter">
          <option value="all" {% if filt == 'all' %}selected{% endif %}>All</option>
          <option value="gainers" {% if filt == 'gainers' %}selected{% endif %}>Gainers</option>
          <option value="losers" {% if filt == 'losers' %}selected{% endif %}>Losers</option>
        </select>
      </div>
      <div>
        <label>Sort</label>
        <select class="retro-input" name="sort">
          <option value="market_cap" {% if sort == 'market_cap' %}selected{% endif %}>Market Cap</option>
          <option value="price" {% if sort == 'price' %}selected{% endif %}>Price</option>
          <option value="change_24h" {% if sort == 'change_24h' %}selected{% endif %}>24h Change</option>
          <option value="stage" {% if sort == 'stage' %}selected{% endif %}>Stage</option>
        </select>
      </div>
      <div>
        <label>Order</label>
        <select class="retro-input" name="order">
          <option value="desc" {% if order == 'desc' %}selected{% endif %}>Desc</option>
          <option value="asc" {% if order == 'asc' %}selected{% endif %}>Asc</option>
        </select>
      </div>
      <div>
        <label>Price Min</label>
        <input class="retro-input" type="text" name="price_min" value="{{ price_min }}" placeholder="0" />
      </div>
      <div>
        <label>Price Max</label>
        <input class="retro-input" type="text" name="price_max" value="{{ price_max }}" placeholder="" />
      </div>
      <div>
        <label>% Change Min</label>
        <input class="retro-input" type="text" name="change_min" value="{{ change_min }}" placeholder="-5" />
      </div>
      <div>
        <label>% Change Max</label>
        <input class="retro-input" type="text" name="change_max" value="{{ change_max }}" placeholder="5" />
      </div>
      <div>
        <label>Per Page</label>
        <select class="retro-input" name="per">
          {% for n in [8,12,16,24] %}
            <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Stage</label>
        <select class="retro-input" name="stage">
          <option value="all" {% if stage == 'all' %}selected{% endif %}>All</option>
          <option value="1" {% if stage == '1' %}selected{% endif %}>1</option>
          <option value="2" {% if stage == '2' %}selected{% endif %}>2</option>
          <option value="3" {% if stage == '3' %}selected{% endif %}>3</option>
          <option value="4" {% if stage == '4' %}selected{% endif %}>4</option>
        </select>
      </div>
      <div>
        <label>Category</label>
        <input class="retro-input" type="text" name="category" value="{{ category }}" placeholder="e.g. meme, ai" />
      </div>
      <div>
        <button class="retro-button" type="submit">Apply</button>
      </div>
    </form>
  </section>

  {% if top_categories %}
  <section class="card">
    <h2>Top Categories</h2>
    <div style="display:flex; flex-wrap: wrap; gap: 8px;">
      {% for cat in top_categories %}
        <a class="retro-button" href="{{ url_for('web.explore', category=cat) }}">#{{ cat }}</a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="card">
    <h2>Highlights</h2>
    <div class="pf-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
      <div class="card">
        <h3>Most Active (24h)</h3>
        <div class="pf-grid">
          {% for row in most_active_24h %}
            <div class="card pf-token-card">
              <div class="pf-token-header">
                <span class="badge">{{ row.token.symbol }}</span>
                <span>{{ row.token.name }}</span>
              </div>
              <div class="pf-token-body">
                <div>Volume 24h: <span class="pf-green">{{ '%.2f'|format(row.vol_24h or 0) }}</span></div>
              </div>
              <div class="pf-card-actions">
                <a class="retro-button" href="{{ url_for('web.token_detail', symbol=row.token.symbol) }}">Details</a>
                <a class="retro-button" href="{{ url_for('web.pool', symbol=row.token.symbol) }}">Pool</a>
              </div>
            </div>
          {% else %}
            <div>No data.</div>
          {% endfor %}
        </div>
      </div>

      <div class="card">
        <h3>Trending</h3>
        <div class="pf-grid">
          {% for it in trending_items %}
            <div class="card pf-token-card">
              <div class="pf-token-header">
                <span class="badge">{{ it.symbol }}</span>
                <span>{{ it.name }}</span>
              </div>
              <div class="pf-token-body">
                <div>Price: <span class="pf-green">{{ '%.4f'|format(it.price or 0) }}</span></div>
                <div>Volume 24h: <span class="pf-green">{{ '%.2f'|format(it.volume_24h or 0) }}</span></div>
                <div>Stage: <span class="pf-green">{{ it.stage }}</span></div>
              </div>
              <div class="pf-card-actions">
                <a class="retro-button" href="{{ url_for('web.token_detail', symbol=it.symbol) }}">Details</a>
                <a class="retro-button" href="{{ url_for('web.pool', symbol=it.symbol) }}">Pool</a>
              </div>
            </div>
          {% else %}
            <div>No data.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Results</h2>
    <div class="pf-grid">
      {% for token in tokens %}
        <div class="card pf-token-card">
          <div class="pf-token-header">
            <span class="badge">{{ token.symbol }}</span>
            <span>{{ token.name }}</span>
          </div>
          <div class="pf-token-body">
            <div>Price: <span class="pf-green">{{ '%.4f'|format((price_by_symbol.get(token.symbol) if price_by_symbol else None) or (token.price or 0)) }}</span></div>
            <div>Market Cap: <span class="pf-green">{{ '%.2f'|format(token.market_cap or 0) }}</span></div>
            <div>24h: <span class="pf-green">{{ '%.2f'|format(token.change_24h or 0) }}%</span></div>
          </div>
          <div class="pf-spark" data-symbol="{{ token.symbol }}" data-price="{{ (price_by_symbol.get(token.symbol) if price_by_symbol else None) or (token.price or 0) }}"></div>
          <div class="pf-card-actions">
            <a class="retro-button" href="{{ url_for('web.token_detail', symbol=token.symbol) }}">Details</a>
            <a class="retro-button" href="{{ url_for('web.pool', symbol=token.symbol) }}">Pool</a>
          </div>
        </div>
      {% else %}
        <div>No results.</div>
      {% endfor %}
    </div>
    <div class="pf-pagination">
      <div>Page {{ page }} of {{ pages }} ({{ total }} results)</div>
      <div class="pf-pagination-controls">
        {% set args = request.args.to_dict() %}
        <a class="retro-button" href="{{ url_for('web.export_explore_csv', **args) }}">Export CSV</a>
        {% if page > 1 %}
          {% set prev_args = args.copy() %}
          {% set _ = prev_args.update({'page': page - 1}) %}
          <a class="retro-button" href="{{ url_for('web.explore', **prev_args) }}">Prev</a>
        {% endif %}
        {% if page < pages %}
          {% set next_args = args.copy() %}
          {% set _ = next_args.update({'page': page + 1}) %}
          <a class="retro-button" href="{{ url_for('web.explore', **next_args) }}">Next</a>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
