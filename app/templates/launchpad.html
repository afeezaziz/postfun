{% extends 'base.html' %}
{% block title %}Launchpad | Postfun{% endblock %}
{% block content %}
  <!-- Launchpad Header -->
  <section class="hero bg-terminal-black border-2 border-terminal-green p-6 rounded-lg shadow-lg mb-8">
    <div class="hero-content text-center">
      <div class="max-w-4xl">
        <h1 class="text-4xl md:text-5xl font-bold text-terminal-green font-terminal mb-4">üöÄ Launchpad</h1>
        <p class="text-lg text-terminal-dim-green mb-6">Tokenize any X (Twitter) post in seconds. Turn viral content into tradable tokens.</p>

        <!-- Quick Stats -->
        <div class="flex flex-wrap gap-3 justify-center mb-6">
          {% if stats %}
            <div class="terminal-badge border-2 border-terminal-green px-3 py-1">
              <span class="text-terminal-green">üìà {{ stats.tokens or 0 }} tokens launched</span>
            </div>
            <div class="terminal-badge border-2 border-terminal-green px-3 py-1">
              <span class="text-terminal-green">üí∞ {{ stats.volume_24h or 0 }} gUSD volume</span>
            </div>
            <div class="terminal-badge border-2 border-terminal-green px-3 py-1">
              <span class="text-terminal-green">üë• {{ stats.creators or 0 }} creators</span>
            </div>
          {% else %}
            <div class="terminal-badge border-2 border-terminal-green px-3 py-1">
              <span class="text-terminal-green">üöÄ Ready to launch tokens</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- Main Launchpad Form -->
  <section class="terminal-card bg-terminal-black border-2 border-terminal-green p-6 rounded-lg shadow-lg mb-8">
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-terminal-green font-terminal mb-3">Tokenize X Post</h2>
      <p class="text-terminal-dim-green">Paste an X post URL to create a token with 1B supply paired with 19M sats</p>
    </div>

    <!-- URL Input Section -->
    <div class="mb-8">
      <div class="max-w-2xl mx-auto">
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
          <div class="flex-1">
            <label class="block text-terminal-green text-sm font-bold mb-2">
              üîó X Post URL <span class="text-terminal-red">*</span>
            </label>
            <input
              type="url"
              id="postUrl"
              name="post_url"
              class="terminal-input input-bordered w-full"
              placeholder="https://x.com/username/status/123456789"
              value="{{ form.post_url or '' }}"
              required
            />
          </div>
          <div class="flex items-end">
            <button
              type="button"
              onclick="fetchPostPreview()"
              class="terminal-button w-full sm:w-auto"
            >
              Fetch Post
            </button>
          </div>
        </div>

        <!-- Post Preview -->
        <div id="postPreview" class="hidden terminal-card bg-terminal-black border border-terminal-green p-4 rounded-lg">
          <div class="flex items-start gap-4">
            <img id="postAvatar" src="" alt="Avatar" class="w-12 h-12 rounded-full" />
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span id="postAuthor" class="text-terminal-green font-bold"></span>
                <span id="postHandle" class="text-terminal-dim-green text-sm"></span>
              </div>
              <div id="postContent" class="text-terminal-green mb-3"></div>
              <div class="flex items-center gap-4 text-terminal-dim-green text-sm">
                <span>üìÖ <span id="postDate"></span></span>
                <span>‚ù§Ô∏è <span id="postLikes"></span></span>
                <span>üîÑ <span id="postRetweets"></span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Token Creation Form -->
    <form method="POST" action="{{ url_for('web.tokens.launchpad') }}" class="max-w-4xl mx-auto">
      <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}" />
      <input type="hidden" id="hiddenPostUrl" name="post_url" value="{{ form.post_url or '' }}" />
      <input type="hidden" id="hiddenSymbol" name="symbol" value="{{ form.symbol or '' }}" />
      <input type="hidden" id="hiddenName" name="name" value="{{ form.name or '' }}" />

      <!-- Token Info Display (Auto-generated) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Token Symbol -->
        <div>
          <label class="block text-terminal-green font-bold mb-2">
            Token Symbol
          </label>
          <div id="symbolDisplay" class="terminal-input input-bordered w-full bg-terminal-dim-green/10">
            {{ form.symbol or 'TBD' }}
          </div>
          <div class="text-terminal-dim-green text-xs mt-1">Auto-generated from post ID</div>
        </div>

        <!-- Token Name -->
        <div>
          <label class="block text-terminal-green font-bold mb-2">
            Token Name
          </label>
          <div id="nameDisplay" class="terminal-input input-bordered w-full bg-terminal-dim-green/10">
            {{ form.name or 'TBD' }}
          </div>
          <div class="text-terminal-dim-green text-xs mt-1">Auto-generated from post ID</div>
        </div>

        <!-- Token Supply -->
        <div>
          <label class="block text-terminal-green font-bold mb-2">
            Total Supply
          </label>
          <div class="terminal-input input-bordered w-full bg-terminal-dim-green/10">
            1,000,000,000
          </div>
          <div class="text-terminal-dim-green text-xs mt-1">Fixed supply for all tokens</div>
        </div>

        <!-- BTC Pairing -->
        <div>
          <label class="block text-terminal-green font-bold mb-2">
            Virtual BTC Liquidity
          </label>
          <div class="terminal-input input-bordered w-full bg-terminal-dim-green/10">
            19,000,000 sats
          </div>
          <div class="text-terminal-dim-green text-xs mt-1">Fixed virtual liquidity</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button type="submit" id="launchButton" class="terminal-button text-lg px-8 py-3" disabled>
          üöÄ Launch Token
        </button>
        <button type="reset" class="terminal-button text-lg px-8 py-3" onclick="resetForm()">
          üîÑ Reset Form
        </button>
      </div>
    </form>
  </section>

  <!-- Recent Tokens -->
  <section class="terminal-card bg-terminal-black border-2 border-terminal-green p-6 rounded-lg shadow-lg">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-terminal-green font-terminal flex items-center">
        <span class="mr-2">üî•</span> Recent Launches
      </h2>
      <a href="{{ url_for('web.tokens.tokens_list') }}" class="terminal-button text-sm">
        View All
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Sample recent tokens - these should come from the backend -->
      <div class="terminal-card bg-terminal-black border border-terminal-green p-4 rounded-lg hover:border-terminal-green/80 transition-all duration-300">
        <div class="flex items-center justify-between mb-2">
          <span class="terminal-badge border-2 border-terminal-green px-2 py-1">SAMPLE</span>
          <span class="text-terminal-green text-sm">2h ago</span>
        </div>
        <div class="text-terminal-green font-bold mb-1">Sample Token</div>
        <div class="text-terminal-dim-green text-sm mb-2">First token on platform</div>
        <div class="flex justify-between text-sm">
          <span class="text-terminal-green">Price: 0.001</span>
          <span class="text-terminal-green">MCap: 10K</span>
        </div>
      </div>

      <div class="terminal-card bg-terminal-black border border-terminal-green p-4 rounded-lg hover:border-terminal-green/80 transition-all duration-300">
        <div class="flex items-center justify-between mb-2">
          <span class="terminal-badge border-2 border-terminal-green px-2 py-1">DEMO</span>
          <span class="text-terminal-green text-sm">5h ago</span>
        </div>
        <div class="text-terminal-green font-bold mb-1">Demo Coin</div>
        <div class="text-terminal-dim-green text-sm mb-2">Demo token for testing</div>
        <div class="flex justify-between text-sm">
          <span class="text-terminal-green">Price: 0.005</span>
          <span class="text-terminal-green">MCap: 50K</span>
        </div>
      </div>

      <div class="terminal-card bg-terminal-black border border-terminal-green p-4 rounded-lg hover:border-terminal-green/80 transition-all duration-300">
        <div class="flex items-center justify-between mb-2">
          <span class="terminal-badge border-2 border-terminal-green px-2 py-1">TEST</span>
          <span class="text-terminal-green text-sm">1d ago</span>
        </div>
        <div class="text-terminal-green font-bold mb-1">Test Token</div>
        <div class="text-terminal-dim-green text-sm mb-2">Testing the waters</div>
        <div class="flex justify-between text-sm">
          <span class="text-terminal-green">Price: 0.0001</span>
          <span class="text-terminal-green">MCap: 100K</span>
        </div>
      </div>
    </div>
  </section>

  <script>
    function extractPostId(url) {
      // Extract post ID from X/Twitter URL including complex URLs with /photo/1
      const patterns = [
        /https:\/\/(twitter\.com|x\.com)\/.*\/status\/(\d+)/,  // Basic status URL
        /https:\/\/(twitter\.com|x\.com)\/.*\/status\/(\d+)\/.*/,  // Status with additional paths
      ];

      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          return match[2];
        }
      }
      return null;
    }

    function generateTokenName(postId) {
      // Use post ID as token name
      return postId;
    }

    function generateTokenSymbol(postId) {
      // Use post ID as token symbol
      return postId;
    }

    function fetchPostPreview() {
      const url = document.getElementById('postUrl').value.trim();
      const previewDiv = document.getElementById('postPreview');
      const launchButton = document.getElementById('launchButton');

      console.log('URL entered:', url);

      if (!url) {
        alert('Please enter an X post URL');
        return;
      }

      // Extract post ID
      const postId = extractPostId(url);
      console.log('Extracted post ID:', postId);

      if (!postId) {
        alert('Could not extract post ID from URL. Please check the URL format.');
        return;
      }

      // Show loading state
      previewDiv.innerHTML = '<div class="text-terminal-dim-green">Processing URL...</div>';
      previewDiv.classList.remove('hidden');

      // Process immediately
      setTimeout(() => {
        try {
          // Extract username from URL for display
          const urlMatch = url.match(/https:\/\/(twitter\.com|x\.com)\/([^\/]+)\/status\/\d+/);
          const username = urlMatch ? urlMatch[2] : 'Unknown User';
          console.log('Extracted username:', username);

          // Generate token details from post ID
          const tokenName = generateTokenName(postId);
          const tokenSymbol = generateTokenSymbol(postId);
          console.log('Token name:', tokenName, 'Token symbol:', tokenSymbol);

          // Update preview with post ID information
          const avatar = document.getElementById('postAvatar');
          const author = document.getElementById('postAuthor');
          const handle = document.getElementById('postHandle');
          const content = document.getElementById('postContent');
          const date = document.getElementById('postDate');
          const likes = document.getElementById('postLikes');
          const retweets = document.getElementById('postRetweets');

          if (avatar) avatar.src = `https://picsum.photos/seed/${username}/100/100.jpg`;
          if (author) author.textContent = username.charAt(0).toUpperCase() + username.slice(1);
          if (handle) handle.textContent = `@${username}`;
          if (content) content.textContent = `Twitter Post ID: ${postId}`;
          if (date) date.textContent = 'Just now';
          if (likes) likes.textContent = 'N/A';
          if (retweets) retweets.textContent = 'N/A';

          // Update hidden form fields
          const hiddenPostUrl = document.getElementById('hiddenPostUrl');
          const hiddenSymbol = document.getElementById('hiddenSymbol');
          const hiddenName = document.getElementById('hiddenName');

          if (hiddenPostUrl) hiddenPostUrl.value = url;
          if (hiddenSymbol) hiddenSymbol.value = tokenSymbol;
          if (hiddenName) hiddenName.value = tokenName;

          // Update display fields
          const symbolDisplay = document.getElementById('symbolDisplay');
          const nameDisplay = document.getElementById('nameDisplay');

          if (symbolDisplay) symbolDisplay.textContent = tokenSymbol;
          if (nameDisplay) nameDisplay.textContent = tokenName;

          // Enable launch button
          if (launchButton) {
            launchButton.disabled = false;
            launchButton.classList.remove('opacity-50');
          }

          console.log('Preview update completed');
        } catch (error) {
          console.error('Error in fetchPostPreview:', error);
          previewDiv.innerHTML = '<div class="text-terminal-red">Error processing URL. Please try again.</div>';
        }
      }, 100); // Very short delay
    }

    function resetForm() {
      // Reset all form fields and disable launch button
      document.getElementById('postUrl').value = '';
      document.getElementById('hiddenPostUrl').value = '';
      document.getElementById('hiddenSymbol').value = '';
      document.getElementById('hiddenName').value = '';
      document.getElementById('symbolDisplay').textContent = 'TBD';
      document.getElementById('nameDisplay').textContent = 'TBD';
      document.getElementById('postPreview').classList.add('hidden');
      document.getElementById('launchButton').disabled = true;
      document.getElementById('launchButton').classList.add('opacity-50');
    }

    // Allow Enter key to trigger fetch
    document.getElementById('postUrl').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        fetchPostPreview();
      }
    });

    // Enable launch button on form validation
    document.getElementById('postUrl').addEventListener('input', function(e) {
      const url = e.target.value.trim();
      const launchButton = document.getElementById('launchButton');
      const postId = extractPostId(url);

      if (postId && document.getElementById('hiddenSymbol').value) {
        launchButton.disabled = false;
        launchButton.classList.remove('opacity-50');
      } else {
        launchButton.disabled = true;
        launchButton.classList.add('opacity-50');
      }
    });
  </script>
{% endblock %}
